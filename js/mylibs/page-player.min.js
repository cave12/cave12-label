var pagePlayer=null;function PagePlayer(){var l=this,f=this,c=soundManager,d,j=null,k=null,g=document.getElementsByTagName("head")[0],i=null,a=navigator.userAgent,h=(a.match(/(opera|firefox)/i)),e=(a.match(/ipad|ipod|iphone/i)),b;this.config={usePeakData:false,useWaveformData:false,useEQData:false,fillGraph:false,allowRightClick:true,useThrottling:true,autoStart:false,playNext:true,updatePageTitle:true,emptyTime:"-:--",useFavIcon:false};this.css={sDefault:"sm2_link",sLoading:"sm2_loading",sPlaying:"sm2_playing",sPaused:"sm2_paused"};this.sounds=[];this.soundsByObject=[];this.lastSound=null;this.soundCount=0;this.strings=[];this.dragActive=false;this.dragExec=new Date();this.dragTimer=null;this.pageTitle=document.title;this.lastWPExec=new Date();this.lastWLExec=new Date();this.vuMeterData=[];this.oControls=null;this._mergeObjects=function(n,m){var r={},q,p,s;for(p in n){if(n.hasOwnProperty(p)){r[p]=n[p]}}q=(typeof m==="undefined"?{}:m);for(s in q){if(typeof r[s]==="undefined"){r[s]=q[s]}}return r};d=(function(){var o=(window.attachEvent&&!window.addEventListener),q=Array.prototype.slice,n={add:(o?"attachEvent":"addEventListener"),remove:(o?"detachEvent":"removeEventListener")};function r(v){var u=q.call(v),t=u.length;if(o){u[1]="on"+u[1];if(t>3){u.pop()}}else{if(t===3){u.push(false)}}return u}function p(t,w){var u=t.shift(),v=[n[w]];if(o){u[v](t[0],t[1])}else{u[v].apply(u,t)}}function s(){p(r(arguments),"add")}function m(){p(r(arguments),"remove")}return{add:s,remove:m}}());this.hasClass=function(n,m){return(typeof(n.className)!=="undefined"?new RegExp("(^|\\s)"+m+"(\\s|$)").test(n.className):false)};this.addClass=function(n,m){if(!n||!m||l.hasClass(n,m)){return false}n.className=(n.className?n.className+" ":"")+m};this.removeClass=function(n,m){if(!n||!m||!l.hasClass(n,m)){return false}n.className=n.className.replace(new RegExp("( "+m+")|("+m+")","g"),"")};this.select=function(n,o){var m=l.getByClassName(n,"div",o||null);return(m?m[0]:null)};this.getByClassName=(document.querySelectorAll?function(o,n,q){var p=("."+o),m;if(n){n=n.split(" ")}m=(n.length>1?n.join(p+", "):n[0]+p);return(q?q:document).querySelectorAll(m)}:function(q,m,t){var r=(t?t:document),s=[],p,o,n=[];if(m){m=m.split(" ")}if(m instanceof Array){for(p=m.length;p--;){if(!n||!n[m[p]]){n[m[p]]=r.getElementsByTagName(m[p])}}for(p=m.length;p--;){for(o=n[m[p]].length;o--;){if(l.hasClass(n[m[p]][o],q)){s.push(n[m[p]][o])}}}}else{n=r.all||r.getElementsByTagName("*");for(p=0,o=n.length;p<o;p++){if(l.hasClass(n[p],q)){s.push(n[p])}}}return s});this.isChildOfClass=function(n,m){if(!n||!m){return false}while(n.parentNode&&!l.hasClass(n,m)){n=n.parentNode}return(l.hasClass(n,m))};this.getParentByNodeName=function(n,m){if(!n||!m){return false}m=m.toLowerCase();while(n.parentNode&&m!==n.parentNode.nodeName.toLowerCase()){n=n.parentNode}return(n.parentNode&&m===n.parentNode.nodeName.toLowerCase()?n.parentNode:null)};this.getOffX=function(m){var n=0;if(m.offsetParent){while(m.offsetParent){n+=m.offsetLeft;m=m.offsetParent}}else{if(m.x){n+=m.x}}return n};this.getTime=function(n,o){var m=Math.floor(n/1000),p=Math.floor(m/60),q=m-(p*60);return(o?(p+":"+(q<10?"0"+q:q)):{min:p,sec:q})};this.getSoundByObject=function(m){return(typeof l.soundsByObject[m.id]!=="undefined"?l.soundsByObject[m.id]:null)};this.getPreviousItem=function(m){if(m.previousElementSibling){m=m.previousElementSibling}else{m=m.previousSibling;while(m&&m.previousSibling&&m.previousSibling.nodeType!==1){m=m.previousSibling}}if(m.nodeName.toLowerCase()!=="li"){return null}else{return m.getElementsByTagName("a")[0]}};this.playPrevious=function(n){if(!n){n=l.lastSound}if(!n){return false}var m=l.getPreviousItem(n._data.oLI);if(m){f.handleClick({target:m})}return m};this.getNextItem=function(m){if(m.nextElementSibling){m=m.nextElementSibling}else{m=m.nextSibling;while(m&&m.nextSibling&&m.nextSibling.nodeType!==1){m=m.nextSibling}}if(m.nodeName.toLowerCase()!=="li"){return null}else{return m.getElementsByTagName("a")[0]}};this.playNext=function(n){if(!n){n=l.lastSound}if(!n){return false}var m=l.getNextItem(n._data.oLI);if(m){f.handleClick({target:m})}return m};this.setPageTitle=function(m){if(!l.config.updatePageTitle){return false}try{document.title=(m?m+" - ":"")+l.pageTitle}catch(n){l.setPageTitle=function(){return false}}};this.events={play:function(){f.removeClass(this._data.oLI,this._data.className);this._data.className=f.css.sPlaying;f.addClass(this._data.oLI,this._data.className);l.setPageTitle(this._data.originalTitle)},stop:function(){f.removeClass(this._data.oLI,this._data.className);this._data.className="";this._data.oPosition.style.width="0px";l.setPageTitle();l.resetPageIcon()},pause:function(){if(f.dragActive){return false}f.removeClass(this._data.oLI,this._data.className);this._data.className=f.css.sPaused;f.addClass(this._data.oLI,this._data.className);l.setPageTitle();l.resetPageIcon()},resume:function(){if(f.dragActive){return false}f.removeClass(this._data.oLI,this._data.className);this._data.className=f.css.sPlaying;
f.addClass(this._data.oLI,this._data.className)},finish:function(){f.removeClass(this._data.oLI,this._data.className);this._data.className="";this._data.oPosition.style.width="0px";if(l.config.playNext){f.playNext(this)}else{l.setPageTitle();l.resetPageIcon()}},whileloading:function(){function m(){this._data.oLoading.style.width=(((this.bytesLoaded/this.bytesTotal)*100)+"%");if(!this._data.didRefresh&&this._data.metadata){this._data.didRefresh=true;this._data.metadata.refresh()}}if(!f.config.useThrottling){m.apply(this)}else{var n=new Date();if(n&&n-l.lastWLExec>30||this.bytesLoaded===this.bytesTotal){m.apply(this);l.lastWLExec=n}}},onload:function(){if(!this.loaded){var n=this._data.oLI.getElementsByTagName("a")[0],o=n.innerHTML,m=this;n.innerHTML=o+' <span style="font-size:0.5em"> | Load failed, d\'oh! '+(c.sandbox.noRemote?" Possible cause: Flash sandbox is denying remote URL access.":(c.sandbox.noLocal?"Flash denying local filesystem access":"404?"))+"</span>";setTimeout(function(){n.innerHTML=o},5000)}else{if(this._data.metadata){this._data.metadata.refresh()}}},whileplaying:function(){var m=null;if(f.dragActive||!f.config.useThrottling){l.updateTime.apply(this);if(c.flashVersion>=9){if(f.config.usePeakData&&this.instanceOptions.usePeakData){l.updatePeaks.apply(this)}if(f.config.useWaveformData&&this.instanceOptions.useWaveformData||f.config.useEQData&&this.instanceOptions.useEQData){l.updateGraph.apply(this)}}if(this._data.metadata){m=new Date();if(m&&m-l.lastWPExec>500){this._data.metadata.refreshMetadata(this);l.lastWPExec=m}}this._data.oPosition.style.width=(((this.position/l.getDurationEstimate(this))*100)+"%")}else{m=new Date();if(m-l.lastWPExec>30){l.updateTime.apply(this);if(c.flashVersion>=9){if(f.config.usePeakData&&this.instanceOptions.usePeakData){l.updatePeaks.apply(this)}if(f.config.useWaveformData&&this.instanceOptions.useWaveformData||f.config.useEQData&&this.instanceOptions.useEQData){l.updateGraph.apply(this)}}if(this._data.metadata){this._data.metadata.refreshMetadata(this)}this._data.oPosition.style.width=(((this.position/l.getDurationEstimate(this))*100)+"%");l.lastWPExec=m}}}};this.setPageIcon=function(n){if(!l.config.useFavIcon||!l.config.usePeakData||!n){return false}var m=document.getElementById("sm2-favicon");if(m){g.removeChild(m);m=null}if(!m){m=document.createElement("link");m.id="sm2-favicon";m.rel="shortcut icon";m.type="image/png";m.href=n;document.getElementsByTagName("head")[0].appendChild(m)}};this.resetPageIcon=function(){if(!l.config.useFavIcon){return false}var m=document.getElementById("favicon");if(m){m.href="/favicon.ico"}};this.updatePeaks=function(){var n=this._data.oPeak,m=n.getElementsByTagName("span");m[0].style.marginTop=(13-(Math.floor(15*this.peakData.left))+"px");m[1].style.marginTop=(13-(Math.floor(15*this.peakData.right))+"px");if(c.flashVersion>8&&l.config.useFavIcon&&l.config.usePeakData){l.setPageIcon(l.vuMeterData[parseInt(16*this.peakData.left,10)][parseInt(16*this.peakData.right,10)])}};this.updateGraph=function(){if(f.config.flashVersion<9||(!f.config.useWaveformData&&!f.config.useEQData)){return false}var p=this._data.oGraph.getElementsByTagName("div"),o,m,n;if(f.config.useWaveformData){o=8;for(m=255;m--;){p[255-m].style.marginTop=(1+o+Math.ceil(this.waveformData.left[m]*-o))+"px"}}else{n=9;for(m=255;m--;){p[255-m].style.marginTop=((n*2)-1+Math.ceil(this.eqData[m]*-n))+"px"}}};this.resetGraph=function(){if(!f.config.useEQData||f.config.flashVersion<9){return false}var p=this._data.oGraph.getElementsByTagName("div"),o=(!f.config.useEQData?"9px":"17px"),m=(!f.config.fillGraph?"1px":"32px"),n;for(n=255;n--;){p[255-n].style.marginTop=o;p[255-n].style.height=m}};this.updateTime=function(){var m=l.strings.timing.replace("%s1",l.getTime(this.position,true));m=m.replace("%s2",l.getTime(l.getDurationEstimate(this),true));this._data.oTiming.innerHTML=m};this.getTheDamnTarget=function(m){return(m.target||(window.event?window.event.srcElement:null))};this.withinStatusBar=function(m){return(l.isChildOfClass(m,"controls"))};this.handleClick=function(r){if(r.button===2){if(!f.config.allowRightClick){f.stopEvent(r)}return f.config.allowRightClick}var u=l.getTheDamnTarget(r),p,t,m,n,q,s;if(!u){return true}if(l.dragActive){l.stopDrag()}if(l.withinStatusBar(u)){return false}if(u.nodeName.toLowerCase()!=="a"){u=l.getParentByNodeName(u,"a")}if(!u){return true}p=u.getAttribute("href");if(!u.href||(!c.canPlayLink(u)&&!l.hasClass(u,"playable"))||l.hasClass(u,"exclude")){return true}else{l.initUL(l.getParentByNodeName(u,"ul"));l.initItem(u);t=u.href;m=l.getSoundByObject(u);if(m){l.setPageTitle(m._data.originalTitle);if(m===l.lastSound){if(m.readyState!==2){if(m.playState!==1){m.play()}else{m.togglePause()}}else{c._writeDebug("Warning: sound failed to load (security restrictions, 404 or bad format)",2)}}else{if(l.lastSound){l.stopSound(l.lastSound)}if(i){m._data.oTimingBox.appendChild(i)}m.togglePause()}}else{m=c.createSound({id:u.id,url:decodeURI(t),onplay:l.events.play,onstop:l.events.stop,onpause:l.events.pause,onresume:l.events.resume,onfinish:l.events.finish,whileloading:l.events.whileloading,whileplaying:l.events.whileplaying,onmetadata:l.events.metadata,onload:l.events.onload});
n=l.oControls.cloneNode(true);q=u.parentNode;q.appendChild(n);if(i){q.appendChild(i)}l.soundsByObject[u.id]=m;m._data={oLink:u,oLI:q,oControls:l.select("controls",q),oStatus:l.select("statusbar",q),oLoading:l.select("loading",q),oPosition:l.select("position",q),oTimingBox:l.select("timing",q),oTiming:l.select("timing",q).getElementsByTagName("div")[0],oPeak:l.select("peak",q),oGraph:l.select("spectrum-box",q),className:l.css.sPlaying,originalTitle:u.innerHTML,metadata:null};if(i){m._data.oTimingBox.appendChild(i)}if(m._data.oLI.getElementsByTagName("ul").length){m._data.metadata=new Metadata(m)}s=l.strings.timing.replace("%s1",l.config.emptyTime);s=s.replace("%s2",l.config.emptyTime);m._data.oTiming.innerHTML=s;l.sounds.push(m);if(l.lastSound){l.stopSound(l.lastSound)}l.resetGraph.apply(m);m.play()}l.lastSound=m;return l.stopEvent(r)}};this.handleMouseDown=function(m){if(e&&m.touches){m=m.touches[0]}if(m.button===2){if(!f.config.allowRightClick){f.stopEvent(m)}return f.config.allowRightClick}var n=l.getTheDamnTarget(m);if(!n){return true}if(!l.withinStatusBar(n)){return true}l.dragActive=true;l.lastSound.pause();l.setPosition(m);if(!e){d.add(document,"mousemove",l.handleMouseMove)}else{d.add(document,"touchmove",l.handleMouseMove)}l.addClass(l.lastSound._data.oControls,"dragging");return l.stopEvent(m)};this.handleMouseMove=function(m){if(e&&m.touches){m=m.touches[0]}if(l.dragActive){if(l.config.useThrottling){var n=new Date();if(n-l.dragExec>20){l.setPosition(m)}else{window.clearTimeout(l.dragTimer);l.dragTimer=window.setTimeout(function(){l.setPosition(m)},20)}l.dragExec=n}else{l.setPosition(m)}}else{l.stopDrag()}m.stopPropagation=true;return false};this.stopDrag=function(m){if(l.dragActive){l.removeClass(l.lastSound._data.oControls,"dragging");if(!e){d.remove(document,"mousemove",l.handleMouseMove)}else{d.remove(document,"touchmove",l.handleMouseMove)}if(!f.hasClass(l.lastSound._data.oLI,l.css.sPaused)){l.lastSound.resume()}l.dragActive=false;return l.stopEvent(m)}};this.handleStatusClick=function(m){l.setPosition(m);if(!f.hasClass(l.lastSound._data.oLI,l.css.sPaused)){l.resume()}return l.stopEvent(m)};this.stopEvent=function(m){if(typeof m!=="undefined"){if(typeof m.preventDefault!=="undefined"){m.preventDefault()}else{m.stopPropagation=true;m.returnValue=false}}return false};this.setPosition=function(r){var o=l.getTheDamnTarget(r),m,q,n,p;if(!o){return true}q=o;while(!l.hasClass(q,"controls")&&q.parentNode){q=q.parentNode}n=l.lastSound;m=parseInt(r.clientX,10);p=Math.floor((m-l.getOffX(q)-4)/(q.offsetWidth)*l.getDurationEstimate(n));if(!isNaN(p)){p=Math.min(p,n.duration)}if(!isNaN(p)){n.setPosition(p)}};this.stopSound=function(m){c._writeDebug("stopping sound: "+m.sID);c.stop(m.sID);if(!e){c.unload(m.sID)}};this.getDurationEstimate=function(m){if(m.instanceOptions.isMovieStar){return(m.duration)}else{return(!m._data.metadata||!m._data.metadata.data.givenDuration?(m.durationEstimate||0):m._data.metadata.data.givenDuration)}};this.createVUData=function(){var p=0,o=0,n=j.getContext("2d"),r=n.createLinearGradient(0,16,0,0),m,q;r.addColorStop(0,"rgb(0,192,0)");r.addColorStop(0.3,"rgb(0,255,0)");r.addColorStop(0.625,"rgb(255,255,0)");r.addColorStop(0.85,"rgb(255,0,0)");m=n.createLinearGradient(0,16,0,0);q="rgba(0,0,0,0.2)";m.addColorStop(0,q);m.addColorStop(1,"rgba(0,0,0,0.5)");for(p=0;p<16;p++){l.vuMeterData[p]=[]}for(p=0;p<16;p++){for(o=0;o<16;o++){j.setAttribute("width",16);j.setAttribute("height",16);n.fillStyle=m;n.fillRect(0,0,7,15);n.fillRect(8,0,7,15);n.fillStyle=r;n.fillRect(0,15-p,7,16-(16-p));n.fillRect(8,15-o,7,16-(16-o));n.clearRect(0,3,16,1);n.clearRect(0,7,16,1);n.clearRect(0,11,16,1);l.vuMeterData[p][o]=j.toDataURL("image/png")}}};this.testCanvas=function(){var p=document.createElement("canvas"),m=null,n;if(!p||typeof p.getContext==="undefined"){return null}m=p.getContext("2d");if(!m||typeof p.toDataURL!=="function"){return null}try{n=p.toDataURL("image/png")}catch(o){return null}return p};this.initItem=function(m){if(!m.id){m.id="pagePlayerMP3Sound"+(l.soundCount++)}l.addClass(m,l.css.sDefault)};this.initUL=function(m){if(c.flashVersion>=9){l.addClass(m,l.cssBase)}};this.init=function(r){if(r){c._writeDebug("pagePlayer.init(): Using custom configuration");this.config=this._mergeObjects(r,this.config)}else{c._writeDebug("pagePlayer.init(): Using default configuration")}var p,o,t,s,q,m;this.cssBase=[];c.useFlashBlock=true;if(c.flashVersion>=9){c.defaultOptions.usePeakData=this.config.usePeakData;c.defaultOptions.useWaveformData=this.config.useWaveformData;c.defaultOptions.useEQData=this.config.useEQData;if(this.config.usePeakData){this.cssBase.push("use-peak")}if(this.config.useWaveformData||this.config.useEQData){this.cssBase.push("use-spectrum")}this.cssBase=this.cssBase.join(" ");if(this.config.useFavIcon){j=l.testCanvas();if(j&&h){l.createVUData()}else{this.config.useFavIcon=false}}}else{if(this.config.usePeakData||this.config.useWaveformData||this.config.useEQData){c._writeDebug("Page player: Note: soundManager.flashVersion = 9 is required for peak/waveform/EQ features.")
}}k=document.createElement("div");k.innerHTML=['  <div class="controls">','   <div class="statusbar">','    <div class="loading"></div>','    <div class="position"></div>',"   </div>","  </div>",'  <div class="timing">','   <div id="sm2_timing" class="timing-data">','    <span class="sm2_position">%s1</span> / <span class="sm2_total">%s2</span>',"   </div>","  </div>",'  <div class="peak">','   <div class="peak-box"><span class="l"></span><span class="r"></span></div>',"  </div>",' <div class="spectrum-container">','  <div class="spectrum-box">','   <div class="spectrum"></div>',"  </div>"," </div>"].join("\n");if(c.flashVersion>=9){i=l.select("spectrum-container",k);i=k.removeChild(i);o=l.select("spectrum-box",i);t=o.getElementsByTagName("div")[0];s=document.createDocumentFragment();q=null;for(p=256;p--;){q=t.cloneNode(false);q.style.left=(p)+"px";s.appendChild(q)}o.removeChild(t);o.appendChild(s)}else{k.removeChild(l.select("spectrum-container",k));k.removeChild(l.select("peak",k))}l.oControls=k.cloneNode(true);m=l.select("timing-data",k);l.strings.timing=m.innerHTML;m.innerHTML="";m.id="";function n(u){d[u](document,"click",l.handleClick);if(!e){d[u](document,"mousedown",l.handleMouseDown);d[u](document,"mouseup",l.stopDrag)}else{d[u](document,"touchstart",l.handleMouseDown);d[u](document,"touchend",l.stopDrag)}d[u](window,"unload",b)}b=function(){n("remove")};n("add");c._writeDebug("pagePlayer.init(): Ready",1);if(l.config.autoStart){f.handleClick({target:f.getByClassName("playlist","ul")[0].getElementsByTagName("a")[0]})}}}soundManager.useFlashBlock=true;soundManager.onready(function(){pagePlayer=new PagePlayer();pagePlayer.init(typeof PP_CONFIG!=="undefined"?PP_CONFIG:null)});